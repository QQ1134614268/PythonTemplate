<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>网页穿透-js内存数据库(对比H5 indexedDB ??)</title>

    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.js"></script>
    <script src="https://cdn.bootcss.com/element-ui/2.6.1/index.js"></script>
    <link href="https://cdn.bootcss.com/element-ui/2.6.1/theme-chalk/index.css" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body>
<div id="app">
    <div class="nav">
        <el-form :model="history">
            <el-form-item label="token">
                <el-input v-model="history.token" autocomplete="on" style="width: 300px;">
                </el-input>
            </el-form-item>
            <el-form-item label="url">
                <el-input v-model="history.url" autocomplete="on" style="width: 300px;"></el-input>
            </el-form-item>
            <el-form-item label="转换关键字">
                <el-radio v-model="history.need_trans" :label="1">是</el-radio>
                <el-radio v-model="history.need_trans" :label="0">否</el-radio>
            </el-form-item>
        </el-form>
        <div class="historyList">
            <div @click="getHistory(history)" v-for="history in sql_history" class="history">
                {{ history.sql }}
            </div>
        </div>
    </div>
    <div class="body">
        <div style="width: 100%; display: flex;flex-direction: column;">
            <textarea v-model="history.sql" rows="10" autocomplete="on"> </textarea>
            <div>
                <el-button @click="trans_sql_func" type="primary" size="mini" style="float: right"> 查看翻译后sql
                </el-button>
                <el-button @click="searchData" type="primary" size="mini" style="float: right"> 确定</el-button>
            </div>
        </div>
        <el-table class="table" :data="tableData" :render-header="labelHead" style="height: 60%">
            <el-table-column :label="value" :property="value" :key="key" v-for="(value, key) in header"
                             :show-overflow-tooltip="true" align="center">
            </el-table-column>
        </el-table>
        <el-dialog :visible.sync="dialogVisible">
            <h1>翻译后sql</h1>
            <div>
                {{ history.trans_sql }}
            </div>
        </el-dialog>
    </div>
</div>
<script>
    class History {
        constructor(url, token, sql, need_trans, trans_sql) {
            this.url = url
            this.token = token
            this.sql = sql
            this.need_trans = need_trans
            this.trans_sql = trans_sql
        }

        static historyTable = []
        static tableName = "history_table"
        static interval = ""

        static saveToDb() {
            // 1.定时任务(同步持久化) 持久化 如果有更新 2.重复数据清除, 保留最多10数据  3.最新使用数据
            if (!this.interval) {
                let _this = this
                this.interval = setInterval(() => {
                    console.log("开始-持久化")
                    _this.historyTable = History.filterRepeat(_this.historyTable).slice(0, 10)
                    if (localStorage.getItem(_this.tableName) !== JSON.stringify(_this.historyTable)) {
                        console.log(localStorage.getItem(_this.tableName), JSON.stringify(_this.historyTable))
                        localStorage.setItem(_this.tableName, JSON.stringify(_this.historyTable));
                    }
                }, 5 * 1000)
            }
        }

        static saveToDbV2() {
            // 手动持久化,有数据变更时
            this.historyTable = History.filterRepeat(this.historyTable).slice(0, 10)
            if (localStorage.getItem(this.tableName) !== JSON.stringify(this.historyTable)) {
                console.log(localStorage.getItem(this.tableName), JSON.stringify(this.historyTable))
                localStorage.setItem(this.tableName, JSON.stringify(this.historyTable));
            }
        }

        static instance() {
            this.saveToDb();
            if (this.historyTable === undefined || this.historyTable.length === 0) {
                let tmp = JSON.parse(localStorage.getItem(this.tableName));
                if (tmp) {
                    this.historyTable = tmp;
                }
            }
            return this.historyTable;
        }

        static save(data) {
            // 1、使用splice()方法（数组中间）；2、使用push() 方法（数组末尾）3、使用unshift() 方法（数组开头）
            this.instance().unshift(data); // 去重添加
            // this.saveToDbV2() // 入库
        }

        static filterRepeat(arr) {
            // 数组去重 -- 对象数组去重
            let newArr = []
            for (let a of arr) {
                let flag = false
                for (let b of newArr) {
                    if (History.isObjectEqual(a, b)) {
                        flag = true
                    }
                }
                if (flag === false) {
                    newArr.push(a)
                }
            }
            return newArr;
        }

        static isObjectEqual(obj1, obj2) {
            const obj1Keys = Object.keys(obj1);
            const obj2Keys = Object.keys(obj2);

            if (obj1Keys.length !== obj2Keys.length) {
                return false;
            }

            for (let key of obj1Keys) {
                if (obj1[key] !== obj2[key]) {
                    return false;
                }
            }
            return true;
        }
    }

    new Vue(
        {
            el: '#app',
            data: {
                tableData: [],
                header: [],
                sql_history: [
                    new History()
                ],
                history: new History(),
                dialogVisible: false,
            },
            methods: {
                remember() {
                    let rowData = new History(this.history.url, this.history.token, this.history.sql, this.need_trans, this.trans_sql);
                    History.save(rowData)
                    this.sql_history = History.instance()
                },
                getHistory(history) {
                    this.history = new History(history.url, history.token, history.sql, history.need_trans, history.trans_sql);
                },
                init() {
                    this.sql_history = History.instance()
                    if (this.sql_history.length > 0) {
                        let history = this.sql_history[0];
                        this.history = new History(history.url, history.token, history.sql, history.need_trans, history.trans_sql);
                    }
                },
                trans_sql_func() {
                    this.history.trans_sql = this.history.sql
                    let upperSql = this.history.sql.toUpperCase()
                    while (upperSql.indexOf("FROM") !== -1) {
                        let index = upperSql.toUpperCase().indexOf("FROM")
                        upperSql = upperSql.slice(0, index) + "__FRO2__" + upperSql.slice(index + 4)
                        this.history.trans_sql = this.history.trans_sql.slice(0, index) + "__FRO2__" + this.history.trans_sql.slice(index + 4)
                    }
                    this.dialogVisible = true
                },
                async searchData() {
                    this.remember()
                    let data = {sql: this.history.sql, need_trans: this.history.need_trans}
                    if (this.history.need_trans) {
                        data.sql = this.history.trans_sql
                    }
                    if (this.history.url) {
                        let res = await this.post(this.history.url, data)
                        this.tableData = res.data.data
                        let obj = this.tableData[0]
                        this.header = Object.keys(obj)
                    }
                },
                labelHead(h, {column, index}) { //动态表头渲染
                    //let l = column.label.length;
                    //let f = 12; //每个字大小,其实是每个字的比例值,大概会比字体大小打差不多大
                    //column.minWidth = f * l; //字大小乘个数即长度 ,注意不要加px像素，这里minWidth只是一个比例值，不是真正的长度
                    //然后将列标题放在一个div块中，注意块的宽度一定要100%，否则表格显示不完全
                    return h('span', {class: 'table-head', style: {width: '100%'}}, [column.label])
                },
                post(url, data) {
                    return new axios({
                            method: 'POST',
                            url: url,
                            // params: data,
                            data: data,
                            headers: {
                                Authorization: this.history.token,
                            }
                        }
                    )
                },
                get(data, url) {
                    return new axios({
                            method: 'GET',
                            url: url,
                            params: data,
                            headers: {
                                Authorization: this.history.token,
                            }
                        }
                    )
                },
            },
            created() {
                this.init()
            },
            watch: {
                "history.sql"(oldSql, newSql) {
                    if (this.history.need_trans) {
                        this.trans_sql_func()
                    }
                }
            }
        }
    );
</script>
</body>
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    html {
        font-size: 16px;
    }

    #app {
        min-height: 100%;

        display: flex;
    }

    .nav {
        width: 20rem;
        margin: 1rem;
    }

    .body {
        width: 100%;
        padding: 1rem;
    }

    .historyList {
        width: 100%;
        border: #0b9ef2 solid 1px;
        height: 300px;
    }

    .history {
        width: 100%;
        border: aquamarine solid 1px;
        margin: 1px;
    }

    .table {
        border: #0b9ef2 solid 1px;
    }
</style>
</html>
