<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>多路</title>
    <script src="./vconsole.js"></script>
    <script src="./jessibuca-pro-demo.js"></script>
    <script src="./util.js"></script>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.js"></script>
    <link href="https://cdn.bootcss.com/element-ui/2.6.1/theme-chalk/index.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/element-ui/2.6.1/index.js"></script>
</head>
<body>
<div id="app" style="height: 100vh; display: flex">
    <div id="container" style="width: 50%"></div>
    <el-form ref="form" :model="form" style="width: 50%; border:  solid 1px aliceblue">
        <span style="color:red;">注意：将zlm的webrtc播放地址，https:// 修改为 webrtc:// 就可以了;即：webrtc://127.0.0.1/index/api/webrtc?app=live&stream=test&type=play</span>
        <el-form-item label="解码:" style="width: 100rem">
            <el-checkbox-group v-model="decodeType" @change="restartPlay(decodeType)">
                <el-checkbox label="mse" name="type">MediaSource</el-checkbox>
                <el-checkbox label="wcs" name="type">webcodecs</el-checkbox>
                <el-checkbox label="wasm" name="type">wasm</el-checkbox>
                <el-checkbox label="wasm(simd)" name="type">wasm(simd)</el-checkbox>
            </el-checkbox-group>
        </el-form-item>
        <el-form-item label="渲染标签:" style="width: 100rem">
            <el-select v-model="renderDom" onchange="replay()">
                <el-option value="video" selected>video</el-option>
                <el-option value="canvas">canvas</el-option>
            </el-select>
        </el-form-item>
        <el-form-item label="canvas渲染技术:" style="width: 100rem">
            <el-select v-model="isUseWebGPU" onchange="replay()">
                <el-option value="webgl">webgl</el-option>
                <el-option value="webgpu" selected>webgpu</el-option>
            </el-select>
        </el-form-item>
        <el-form-item label="缓存时长:" style="width: 100rem">
            <el-input placeholder="单位：秒" type="text" v-model="videoBuffer" style="width: 50px" value="0.2"/>
            秒
        </el-form-item>
        <el-form-item label="缓存延迟(延迟超过会触发丢帧):" style="width: 100rem">
            <el-input placeholder="单位：秒" type="text" v-model="videoBufferDelay" style="width: 50px" value="1"/>
            秒
        </el-form-item>
        <el-form-item label="硬解码(MediaSource，Webcodec)worker解封装:" style="width: 100rem">
            <el-checkbox @click="replay()" v-model="demuxUseWorker">备选项</el-checkbox>
        </el-form-item>
        <el-form-item label="切换视频的时候，是否显示上一个流的最后一帧画面:" style="width: 100rem">
            <el-checkbox @click="replay()" v-model="showLastIframe"/>
        </el-form-item>
        <el-form-item label="输入URL:" style="width: 100rem">
            <el-input autocomplete="on" :value="playUrl1"/>
            <el-input autocomplete="on" :value="playUrl2"/>
            <el-input autocomplete="on" :value="playUrl3"/>
        </el-form-item>
        <el-button @click="replay">重播</el-button>
        <el-button @click="play">播放</el-button>
        <el-button @click="pause" style="display: none">停止</el-button>
        <el-button @click="destroy">销毁</el-button>
    </el-form>
</div>
<script>
    let t = new Vue(
        {
            el: '#app',
            data() {
                return {
                    form: {},

                    playUrl1: "",
                    playUrl2: "",
                    playUrl3: "",
                    demuxUseWorker: '',
                    showLastIframe: '',
                    renderDom: '',

                    isUseFpsRender: 'false',
                    isCacheBeforeDecodeForFpsRender: 'true',
                    onlyDecoderIFrame: 4,
                    playbackFps: 25,
                    isPlaybackPauseClearCache: 'true',
                    uiUsePlaybackPause: '',
                    isUseWebGPU: '',
                    playbackUseWCS: false,
                    playUrl: '',
                    playTimesArray: [],

                    checked2: checkSupportWCS(),

                    videoBuffer: 0.2,
                    videoBufferDelay: 1,
                    decodeType: '',
                    jessibuca: null,
                    version: '',
                    wasm: false,
                    vc: "ff",
                    playing: false,
                    quieting: true,
                    loaded: false, // mute
                    showOperateBtns: false,
                    showBandwidth: false,
                    err: "",
                    speed: 0,
                    performance: "",
                    volume: 1,
                    rotate: 0,
                    useWCS: false,
                    useMSE: true,
                    useOffscreen: false,
                    recording: false,
                    recordType: 'webm',
                    scale: '0',
                };
            },
            mounted() {
                // this.create();
                // window.onerror = (msg) => (this.err = msg);
            },
            unmounted() {
                this.jessibuca.destroy();
            },
            methods: {
                create(options) {
                    stopLoop();
                    options = options || {};
                    jessibuca = new JessibucaPro({
                        container: $container,
                        videoBuffer: Number($videoBuffer.value), // 缓存时长
                        videoBufferDelay: Number($videoBufferDelay.value), // 1000s
                        isResize: false,
                        controlAutoHide: true,
                        text: "",
                        loadingText: "加载中",
                        debug: true,
                        debugLevel: "debug",
                        useMSE: $useMSE.checked === true,
                        useSIMD: $useSIMD.checked === true,
                        useWCS: $useWCS.checked === true,
                        showBandwidth: showOperateBtns, // 显示网速
                        showPerformance: showOperateBtns, // 显示性能
                        operateBtns: {
                            fullscreen: showOperateBtns,
                            screenshot: showOperateBtns,
                            play: showOperateBtns,
                            audio: showOperateBtns,
                            ptz: showOperateBtns,
                            quality: showOperateBtns,
                            performance: showOperateBtns,
                        },
                        timeout: 10000,
                        heartTimeoutReplayUseLastFrameShow: true,
                        audioEngine: "worklet",
                        qualityConfig: ['普清', '高清', '超清', '4K', '8K'],
                        forceNoOffscreen: forceNoOffscreen,
                        isNotMute: false,
                        heartTimeout: 10,
                        ptzClickType: 'mouseDownAndUp',
                        ptzZoomShow: true,
                        ptzMoreArrowShow: true,
                        ptzApertureShow: true,
                        ptzFocusShow: true,
                        useCanvasRender: $renderDom.value === 'canvas',
                        useWebGPU: $isUseWebGPU.value === 'webgpu',
                        demuxUseWorker: $demuxUseWorker.checked === true,
                        controlHtml: '<div>我是 <span style="color: red">test</span>文案</div>',
                        // audioEngine:"worklet",
                        // isFlv: true
                        ...options
                    },);


                    jessibuca.on('ptz', (arrow) => {
                        // console.log('ptz', arrow);
                    })

                    jessibuca.on('streamQualityChange', (value) => {
                        console.log('streamQualityChange', value);
                    })

                    jessibuca.on('timeUpdate', (value) => {
                        // console.log('timeUpdate', value);
                    })

                    jessibuca.on('stats', (stats) => {
                        // console.log('stats', stats);
                        $fps.textContent = `FPS: ${stats.fps} DFPS: ${stats.dfps}`
                    })


                    $player.style.display = 'inline-block';
                    $pause.style.display = 'none';
                    $destroy.style.display = 'none';
                    $fps.textContent = '';
                },

                play() {
                    stopLoop();
                    var href1 = $playHref1.value;
                    var href2 = $playHref2.value;
                    var href3 = $playHref3.value;
                    const playList = [];
                    if (href1) {
                        playList.push(href1);
                    }
                    if (href2) {
                        playList.push(href2);
                    }
                    if (href3) {
                        playList.push(href3);
                    }
                    const href = playList[index++ % playList.length];

                    if (href) {
                        jessibuca.play(href);
                        $player.style.display = 'none';
                        $pause.style.display = 'inline-block';
                        $destroy.style.display = 'inline-block';
                        startLoop();
                    }
                },
                stopLoop() {
                    if (loopTimer) {
                        clearTimeout(loopTimer);
                        loopTimer = null;
                    }
                },
                startLoop() {
                    loopTimer = setTimeout(() => {
                        const showLastIframe = $showLastIframe.checked === true;
                        if (showLastIframe) {
                            const loadingBg = jessibuca.screenshot('', 'png', 0.92, 'base64');
                            const videoInfo = jessibuca.getVideoInfo();
                            console.log('videoInfo', videoInfo, loadingBg);
                            //  上一个流的最后一帧画面。
                            jessibuca.destroy().then(() => {
                                create({
                                    loadingBackground: loadingBg,
                                    loadingBackgroundWidth: videoInfo.width,
                                    loadingBackgroundHeight: videoInfo.height,
                                });
                                play();
                            });
                        } else {
                            replay();
                        }
                    }, 30 * 1000)
                },
                replay() {
                    if (jessibuca) {
                        jessibuca.destroy().then(() => {
                            create();
                            play();
                        });
                    } else {
                        create();
                        play();
                    }
                },
                pause() {
                    // $playbackPause.style.display = 'none';
                    // $pause.style.display = 'none';
                    // $playScroll.style.display = 'none';
                    // $player.style.display = 'inline-block';
                    this.jessibuca.jessibuca.pause();
                },
                destroy() {
                    if (jessibuca) {
                        stopLoop();
                        jessibuca.destroy();
                    }
                    create();
                },
                restartPlay(type) {
                    replay();

                    if (type === 'mse') {
                        this.useWCS = false;
                        this.useOffscreen = false;
                    } else if (type === 'wcs') {
                        this.useMSE = false
                    } else if (type === 'offscreen') {
                        this.useMSE = false
                    }

                    this.destroy();
                    setTimeout(() => {
                        this.play();
                    }, 100)
                },

            },
        }
    );
</script>

</body>
<style>
    * {
        -webkit-user-select: text;
    }
    #container {
        background: rgba(13, 14, 27, 0.7);
        width: 960px;
        height: 597px;
    }

</style>
</html>
