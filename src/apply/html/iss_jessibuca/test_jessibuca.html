<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>demo</title>
    <script src="https://cdn.bootcss.com/vue/2.6.10/vue.js"></script>
    <link href="https://cdn.bootcss.com/element-ui/2.4.5/theme-chalk/index.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/element-ui/2.6.1/index.js"></script>
</head>
<body>
<div id="app" style="height: 100vh; display: flex">
    <div id="container" ref="container" style="width: 50%"></div>
    <el-form ref="form" :model="form" style="width: 50%">
        <el-form-item label="缓冲(秒):" style="width: 10rem">
            <el-input type="number" v-model="videoBuffer" style="width: 5rem" @change="changeBuffer"></el-input>
        </el-form-item>
        <el-form-item label="解码:" style="width: 100rem">
            <el-checkbox-group v-model="decodeType" @change="restartPlay(decodeType)">
                <el-checkbox label="mse" name="type">MediaSource</el-checkbox>
                <el-checkbox label="wcs" name="type">webcodecs</el-checkbox>
                <el-checkbox label="wasm" name="type">wasm</el-checkbox>
                <el-checkbox label="wasm(simd)" name="type">wasm(simd)</el-checkbox>
            </el-checkbox-group>
        </el-form-item>
        <el-form-item label="播放地址:" style="width: 10rem">
            <el-input v-model="playUrl" style="width: 5rem"></el-input>
        </el-form-item>
        <el-form-item label="操作按钮:" style="width: 10rem">
            <el-checkbox v-model="showOperateBtns">备选项</el-checkbox>
        </el-form-item>
        <el-form-item label="网速:" style="width: 10rem">
            <el-checkbox v-model="showBandwidth">备选项</el-checkbox>
        </el-form-item>
        <el-form-item label="离屏渲染:" style="width: 10rem">
            <el-checkbox v-model="showBandwidth">备选项</el-checkbox>
        </el-form-item>
        <el-form-item label="缩放:" style="width: 10rem">
            <el-select v-model="scale" @change="scaleChange">
                <el-option value="0">完全填充(拉伸)</el-option>
                <el-option value="1">等比缩放</el-option>
                <el-option value="2">完全填充(未拉伸)</el-option>
            </el-select>
        </el-form-item>
        <el-button v-if="!playing" @click="play">播放</el-button>
        <el-button v-else @click="pause">停止</el-button>
        <el-button>重播 todo</el-button>
        <el-button @click="destroy">销毁</el-button>
        <el-button @click="fullscreen">全屏</el-button>
        <el-button @click="screenShot">截图</el-button>
        <el-button @click="clearView">清屏</el-button>
        <span>性能：{{ performance }}</span>
    </el-form>
</div>
<script>
    let t = new Vue(
        {
            el: '#app',
            data() {
                return {
                    form: {
                        videoBuffer: 3
                    },
                    playUrl: '',
                    videoBuffer: 0.2,
                    decodeType: '',
                    jessibuca: null,
                    version: '',
                    wasm: false,
                    vc: "ff",
                    playing: false,
                    quieting: true,
                    loaded: false, // mute
                    showOperateBtns: false,
                    showBandwidth: false,
                    err: "",
                    speed: 0,
                    performance: "",
                    volume: 1,
                    rotate: 0,
                    useWCS: false,
                    useMSE: true,
                    useOffscreen: false,
                    recording: false,
                    recordType: 'webm',
                    scale: '0',
                };
            },
            mounted() {
                // this.create();
                // window.onerror = (msg) => (this.err = msg);
            },
            unmounted() {
                this.jessibuca.destroy();
            },
            methods: {
                create(options) {
                    options = options || {};
                    this.jessibuca = new window.Jessibuca(
                        Object.assign(
                            {
                                // 基础, 调试
                                container: document.getElementById('container'),
                                videoBuffer: this.videoBuffer, // 缓存时长 1
                                decoder: 'decoder.js', // 1 默认引用的是根目录下面的decoder.js文件 ，decoder.js 与 decoder.wasm文件必须是放在同一个目录下面
                                debug: true,
                                timeout: 10, //设置超时时长, 单位秒,在连接成功之前(loading)和播放中途(heart),如果超过设定时长无数据返回,则回调timeout事件
                                loadingTimeout: 10,//设置超时时长, 单位秒,在连接成功之前,如果超过设定时长无数据返回,则回调timeout事件
                                loadingTimeoutReplay: true,//loadingTimeout 心跳超时之后自动再播放,不再抛出异常，而直接重新播放视频地址。
                                loadingTimeoutReplayTimes: -1,// loadingTimeoutReplay 重试失败之后，不再重新播放视频地址。如果想无限次重试，可以设置为-1
                                heartTimeout: 5, //设置超时时长, 单位秒,播放中途,如果超过设定时长无数据返回,则回调timeout事件
                                heartTimeoutReplay: true,//heartTimeout 心跳超时之后自动再播放,不再抛出异常，而直接重新播放视频地址。
                                heartTimeoutReplayTimes: -1,//heartTimeoutReplay 重试失败之后，不再重新播放视频地址。是整个生命周期中重试的次数。如果想无限次重试，可以设置为-1
                                // 性能, 解码
                                forceNoOffscreen: !this.useOffscreen,//是否不使用离屏模式（提升渲染能力）
                                hasAudio: false, // 是否有音频，如果设置false，则不对音频数据解码，提升性能。
                                useMSE: this.useMSE, //是否开启MediaSource硬解码;视频编码只支持H.264视频（Safari on iOS不支持）,不支持 forceNoOffscreen 为 false (开启离屏渲染),优先级高于useWCS:true
                                useWCS: this.useWCS, //是否开启Webcodecs硬解码;视频编码只支持H.264视频 (需在chrome 94版本以上，需要https或者localhost环境);支持 forceNoOffscreen 为 false （开启离屏渲染）
                                wcsUseVideoRender: true, //webcodecs硬解码是否通过video标签渲染;forceNoOffscreen 设置为false之后（通过OffscreenCanvas渲染之），wcsUseVideoRender不会生效;现在默认 video标签渲染，提升渲染性能。
                                autoWasm: true, //在使用MSE或者Webcodecs 播放H265的时候，是否自动降级到wasm模式。设置为false 则直接关闭播放，抛出Error 异常，设置为true 则会自动切换成wasm模式播放。
                                wasmDecodeErrorReplay: true,//是否开启解码失败重新播放;wasm解码报错之后，不再抛出异常，而是直接重新播放视频地址。

                                // UI 配置
                                hiddenAutoPause: false, //是否开启当页面的'visibilityState'变为'hidden'的时候，自动暂停播放。
                                rotate: true, //设置旋转角度，只支持，0(默认) ，180，270 三个值。
                                isResize: false,//当为true的时候：视频画面做等比缩放后,高或宽对齐canvas区域,画面不被拉伸,但有黑边。 等同于 setScaleMode(1) 当为false的时候：视频画面完全填充canvas区域,画面会被拉伸。等同于 setScaleMode(0)
                                isFullResize: false,// 当为true的时候：视频画面做等比缩放后,完全填充canvas区域,画面不被拉伸,没有黑边,但画面显示不全。等同于 setScaleMode(2)
                                supportDblclickFullscreen: true,//是否支持屏幕的双击事件，触发全屏，取消全屏事件。点击底部的 controls UI条(里面元素)不会触发全屏事件。
                                showBandwidth: this.showBandwidth, // 显示网速
                                operateBtns: {
                                    fullscreen: this.showOperateBtns,//fullscreen 是否显示全屏按钮
                                    screenshot: this.showOperateBtns,//是否显示截图按钮
                                    play: this.showOperateBtns,//是否显示播放暂停按钮
                                    audio: this.showOperateBtns,//是否显示声音按钮
                                    record: this.showOperateBtns,     //record 是否显示录制按钮
                                },
                                keepScreenOn: true,// 开启屏幕常亮
                                isNotMute: true,//是否开启声音，默认是关闭声音播放的。
                                loadingText: "疯狂加载中...",//加载过程中文案。
                                background: "", //背景图片。
                                controlAutoHide: false,//只有鼠标聚焦到播放器内部才会显示，移除之后，会消失。

                                // 其他
                                isFlv: false, //当为true的时候：ws协议不检验是否以.flv为依据，进行协议解析。
                                hotKey: false,//是否开启键盘快捷键; esc -> 退出全屏；arrowUp -> 声音增加；arrowDown -> 声音减少；
                                recordType: 'mp4',//默认录制的视频格式;支持 webm,mp4 参数
                                useWebFullScreen: false,// 是否使用web全屏(旋转90度)（只会在移动端生效）。
                            },
                            options
                        )
                    );
                    // -----------方法-----------------------
                    this.jessibuca.setDebug(true)
                    // this.jessibuca.play("url")//播放视频
                    // this.jessibuca.isPlaying()//返回是否正在播放中状态。
                    // this.jessibuca.setTimeout(10)//设置超时时长, 单位秒 在连接成功之前和播放中途,如果超过设定时长无数据返回,则回调timeout事件
                    // this.jessibuca.on("load", function () { //监听方法
                    //   console.log('load')
                    // })
                    // this.jessibuca.mute()//静音
                    // this.jessibuca.cancelMute(true)//取消静音
                    // this.jessibuca.audioResume()//留给上层用户操作来触发音频恢复的方法。
                    // this.jessibuca.setScaleMode(0)//0 视频画面完全填充canvas区域,画面会被拉伸;1 视频画面做等比缩放后,高或宽对齐canvas区域,画面不被拉伸,但有黑边 ;2 视频画面做等比缩放后,完全填充canvas区域,画面不被拉伸,没有黑边
                    // this.jessibuca.pause()//暂停播放
                    // this.jessibuca.close()//关闭视频,不释放底层资源
                    // this.jessibuca.destroy()//关闭视频，释放底层资源
                    // this.jessibuca.clearView()//清理画布为黑色背景
                    // this.jessibuca.resize()//重新调整视图大小
                    // this.jessibuca.setBufferTime(0.2)//设置最大缓冲时长，单位秒，播放器会自动消除延迟。
                    // this.jessibuca.setRotate(0)//设置旋转角度;0(默认), 90, 180, 270
                    // this.jessibuca.setVolume(1)//设置音量大小，取值0 — 1
                    // this.jessibuca.hasLoaded()//返回是否加载完毕;仅为兼容老的vue2.x语法，3.x版本不需要这个事件。
                    // this.jessibuca.setKeepScreenOn()//开启屏幕常亮
                    // this.jessibuca.setFullscreen(true)//全屏(取消全屏)播放视频
                    // this.jessibuca.screenshot("test", "png", 0.5, 'base64')//截图，调用后弹出下载框保存截图;filename: 可选参数, 保存的文件名, 默认 时间戳;format : 可选参数, 截图的格式，可选png或jpeg或者webp ,默认 png;quality: 可选参数, 当格式是jpeg或者webp时，压缩质量，取值0 ~ 1 ,默认 0.92;type: 可选参数, 可选download或者base64或者blob，默认download
                    // this.jessibuca.startRecord('xxx', 'webm')//开始录制。fileName: 可选，默认时间戳;fileType: 可选，默认webm，支持webm 和mp4 格式
                    // this.jessibuca.stopRecordAndSave()//暂停录制并下载。
                    // this.jessibuca.isMute()//是否静音。
                    // this.jessibuca.isRecording()// 是否正在录制。

                    // -----------事件-----------------------
                    let _this = this;
                    let _ts = 0;

                    this.jessibuca.on("play", () => {
                        console.log("on play");
                        this.playing = true;
                        this.loaded = true;
                        this.quieting = this.jessibuca.isMute();
                        _this.playing = true;
                    });
                    this.jessibuca.on("start", function () {
                        console.log('start render')
                        // 如果有截图需求。需要延迟一下，因为代码中无法感应到画面被渲染出来了。
                        // 1s 之后截图
                        // setTimeout(function () {
                        //   this. jessibuca.screenshot('xxx')
                        // }, 1 * 1000)
                    })
                    this.jessibuca.on("pause", function () {
                        console.log("on pause");
                        _this.playing = false;
                    });
                    this.jessibuca.on("load", function () {
                        console.log("on load");
                    });
                    this.jessibuca.on("timeout", function (error) {
                        //jessibuca.TIMEOUT.loadingTimeout ; 同loadingTimeout
                        //jessibuca.TIMEOUT.delayTimeout ; 同delayTimeout
                        console.log('timeout:', error)
                    })
                    this.jessibuca.on("loadingTimeout", function () {
                        console.log('timeout')
                    })
                    this.jessibuca.on("delayTimeout", function () {
                        console.log('timeout')
                    })
                    // 信息
                    this.jessibuca.on('buffer', function (buffer) {
                        console.log('buffer', buffer);
                    })

                    this.jessibuca.on("videoInfo", function (info) {
                        console.log("videoInfo", info);
                    });
                    this.jessibuca.on("audioInfo", function (msg) {
                        console.log("audioInfo", msg);
                    });
                    this.jessibuca.on("timeUpdate", function (ts) {
                        console.log('timeUpdate,old,new,timestamp', _ts, ts, ts - _ts);
                        _ts = ts;
                    });
                    this.jessibuca.on("playToRenderTimes", function (times) { // 监听调用play方法 经过 初始化-> 网络请求-> 解封装 -> 解码 -> 渲染 一系列过程的时间消耗
                        console.log("playToRenderTimes is", times)
                    })
                    this.jessibuca.on('stats', function (stats) {
                        // buf: 当前缓冲区时长，单位毫秒,
                        // fps: 当前视频帧率,
                        // abps: 当前音频码率，单位byte,
                        // vbps: 当前视频码率，单位byte，
                        // ts:当前视频帧pts，单位毫秒
                        console.log('stats', stats);
                    })
                    this.jessibuca.on('kBps', function (kBps) {
                        console.log('kBps', kBps);
                    });
                    this.jessibuca.on("bps", function (bps) {
                        console.log('bps', bps);
                    });
                    this.jessibuca.on("performance", function (performance) { //渲染性能统计，流开始播放后回调，每秒1次。0: 表示卡顿;1: 表示流畅;2: 表示非常流程
                        _this.performance = performance;
                    });
                    this.jessibuca.on("log", function (msg) { //信息，包含错误信息
                        console.log("on log", msg);
                    });
                    this.jessibuca.on("error", function (error) {
                        // jessibuca.ERROR.playError ;播放错误，url 为空的时候，调用play方法
                        // jessibuca.ERROR.fetchError ;http 请求失败
                        // jessibuca.ERROR.websocketError; websocket 请求失败
                        // jessibuca.ERROR.webcodecsH265NotSupport; webcodecs 解码 h265 失败
                        // jessibuca.ERROR.mediaSourceH265NotSupport; mediaSource 解码 h265 失败
                        // jessibuca.ERROR.wasmDecodeError ; wasm 解码失败
                        console.log("error", error);
                    });


                    // 其他
                    this.jessibuca.on("mute", function (msg) {
                        console.log("on mute", msg);
                        _this.quieting = msg;
                    });
                    this.jessibuca.on("fullscreen", function (msg) {
                        console.log("on fullscreen", msg);
                    });

                    this.jessibuca.on("webFullscreen", function (flag) {
                        console.log('is webFullscreen', flag)
                    })
                    this.jessibuca.on("recordStart", function () {//录制开始的事件
                        console.log("record start")
                    })
                    this.jessibuca.on("recordEnd", function () {//录制结束的事件
                        console.log("record end")
                    })
                    this.jessibuca.on("recordingTimestamp", function (timestamp) {// 录制的时候，返回的录制时长，1s一次
                        console.log("recordingTimestamp is", timestamp)
                    })
                },
                play() {
                    // this.jessibuca.onPlay = () => (this.playing = true);
                    if (this.playUrl) {
                        this.jessibuca.play(this.playUrl);
                    }
                },
                mute() {
                    this.jessibuca.mute();
                },
                cancelMute() {
                    this.jessibuca.cancelMute();
                },

                pause() {
                    this.jessibuca.pause();
                    this.playing = false;
                    this.err = "";
                    this.performance = "";
                },
                volumeChange() {
                    this.jessibuca.setVolume(this.volume);
                },
                rotateChange() {
                    this.jessibuca.setRotate(this.rotate);
                },
                destroy() {
                    if (this.jessibuca) {
                        this.jessibuca.destroy();
                    }
                    this.create();
                    this.playing = false;
                    this.loaded = false;
                    this.performance = "";
                },

                fullscreen() {
                    this.jessibuca.setFullscreen(true);
                },

                clearView() {
                    if (this.playing) {
                        this.jessibuca.clearView();
                    }
                },

                startRecord() {
                    const time = new Date().getTime();
                    this.jessibuca.startRecord(time, this.recordType);
                },

                stopAndSaveRecord() {
                    this.jessibuca.stopRecordAndSave();
                },

                screenShot() {
                    this.jessibuca.screenshot();
                },

                restartPlay(type) {

                    if (type === 'mse') {
                        this.useWCS = false;
                        this.useOffscreen = false;
                    } else if (type === 'wcs') {
                        this.useMSE = false
                    } else if (type === 'offscreen') {
                        this.useMSE = false
                    }

                    this.destroy();
                    setTimeout(() => {
                        this.play();
                    }, 100)
                },

                changeBuffer() {
                    this.jessibuca.setBufferTime(Number(this.$refs.buffer.value));
                },

                scaleChange() {
                    this.jessibuca.setScaleMode(this.scale);
                },
            },
        }
    );
</script>
</body>
<style>
    .root {
        display: flex;
        place-content: center;
        margin-top: 3rem;
    }

    .container-shell {
        position: relative;
        backdrop-filter: blur(5px);
        background: hsla(0, 0%, 50%, 0.5);
        padding: 30px 4px 10px 4px;
        /* border: 2px solid black; */
        width: auto;
        position: relative;
        border-radius: 5px;
        box-shadow: 0 10px 20px;
    }

    .container-shell-title {
        position: absolute;
        color: darkgray;
        top: 4px;
        left: 10px;
        text-shadow: 1px 1px black;
    }

    .tag-version {
    }

    #container {
        background: rgba(13, 14, 27, 0.7);
        width: 640px;
        height: 398px;
    }

    .input {
        display: flex;
        align-items: center;
        margin-top: 10px;
        color: white;
        place-content: stretch;
    }

    .input2 {
        bottom: 0px;
    }

    .input input[type='input'] {
        flex: auto;
    }

    .err {
        position: absolute;
        top: 40px;
        left: 10px;
        color: red;
    }

    .option {
        position: absolute;
        top: 4px;
        right: 10px;
        display: flex;
        place-content: center;
        font-size: 12px;
    }

    .option span {
        color: white;
    }

    @media (max-width: 720px) {
        #container {
            width: 90vw;
            height: 52.7vw;
        }
    }
</style>
</html>
